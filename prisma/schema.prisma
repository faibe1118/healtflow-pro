// --- CONFIGURACIÓN ---
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// --- ENUMS (Listas fijas) ---
enum Role {
  PATIENT
  DOCTOR
  ADMIN
}

enum Gender {
  MALE
  FEMALE
  OTHER
}

enum BloodType {
  A_POS
  A_NEG
  B_POS
  B_NEG
  AB_POS
  AB_NEG
  O_POS
  O_NEG
}

enum AllergySeverity {
  MILD
  MODERATE
  CRITICAL
}

enum AppointmentStatus {
  PENDING
  CONFIRMED
  CANCELED
  COMPLETED
}

// --- MODELOS (Tablas) ---

model User {
  id           String   @id @default(uuid()) // UUID automático
  email        String   @unique
  passwordHash String   @map("password_hash")
  role         Role
  isActive     Boolean  @default(true) @map("is_active")
  createdAt    DateTime @default(now()) @map("created_at")

  // Relaciones
  patientProfile Patient?
  doctorProfile  Doctor?

  @@map("users") // Nombre real en la tabla
}

model Patient {
  id                String    @id @default(uuid())
  userId            String    @unique @map("user_id")
  firstName         String?    @map("first_name")
  lastName          String?    @map("last_name")
  dateOfBirth       DateTime?  @map("date_of_birth")
  gender            Gender?
  governmentId      String?   @map("government_id")
  insuranceProvider String?   @map("insurance_provider")
  policyNumber      String?   @map("policy_number")
  bloodType         BloodType? @map("blood_type")
  address           String?   @db.Text

  // Relaciones
  user             User             @relation(fields: [userId], references: [id])
  allergies        PatientAllergy[]
  appointments     Appointment[]
  vitalSigns       VitalSigns[]

  @@map("patients")
}

model Doctor {
  id                   String  @id @default(uuid())
  userId               String  @unique @map("user_id")
  firstName            String?  @map("first_name")
  lastName             String?  @map("last_name")
  medicalLicenseNumber String? @map("medical_license_number")
  bio                  String? @db.Text

  // Relaciones
  user         User              @relation(fields: [userId], references: [id])
  specialties  DoctorSpecialty[]
  appointments Appointment[]
  schedules    DoctorSchedule[]
  diagnoses    Diagnosis[]

  @@map("doctors")
}

// --- DATOS CLÍNICOS ---

model Specialty {
  id   Int    @id @default(autoincrement())
  name String

  doctors DoctorSpecialty[]

  @@map("specialties")
}

// Tabla intermedia Doctor <-> Especialidad
model DoctorSpecialty {
  doctorId    String @map("doctor_id")
  specialtyId Int    @map("specialty_id")

  doctor    Doctor    @relation(fields: [doctorId], references: [id])
  specialty Specialty @relation(fields: [specialtyId], references: [id])

  @@id([doctorId, specialtyId]) // Llave compuesta
  @@map("doctor_specialties")
}

model Allergy {
  id   Int    @id @default(autoincrement())
  name String

  patients PatientAllergy[]

  @@map("allergies")
}

// Tabla intermedia Paciente <-> Alergia (Con severidad)
model PatientAllergy {
  patientId String          @map("patient_id")
  allergyId Int             @map("allergy_id")
  severity  AllergySeverity
  reaction  String?         @db.Text

  patient Patient @relation(fields: [patientId], references: [id])
  allergy Allergy @relation(fields: [allergyId], references: [id])

  @@id([patientId, allergyId])
  @@map("patient_allergies")
}

model VitalSigns {
  id                String   @id @default(uuid())
  patientId         String   @map("patient_id")
  appointmentId     String?  @map("appointment_id")
  weightKg          Float?   @map("weight_kg")
  heightCm          Float?   @map("height_cm")
  systolicPressure  Int?     @map("systolic_pressure")
  diastolicPressure Int?     @map("diastolic_pressure")
  heartRate         Int?     @map("heart_rate")
  recordedAt        DateTime @default(now()) @map("recorded_at")

  patient     Patient      @relation(fields: [patientId], references: [id])
  appointment Appointment? @relation(fields: [appointmentId], references: [id])

  @@map("vital_signs")
}

// --- AGENDAMIENTO ---

model Appointment {
  id        String            @id @default(uuid())
  patientId String            @map("patient_id")
  doctorId  String            @map("doctor_id")
  startTime DateTime          @map("start_time")
  endTime   DateTime          @map("end_time")
  status    AppointmentStatus @default(PENDING)
  reason    String?           @db.Text
  createdAt DateTime          @default(now()) @map("created_at")

  patient    Patient     @relation(fields: [patientId], references: [id])
  doctor     Doctor      @relation(fields: [doctorId], references: [id])
  diagnosis  Diagnosis?
  vitalSigns VitalSigns[]

  @@map("appointments")
}

model DoctorSchedule {
  id           Int      @id @default(autoincrement())
  doctorId     String   @map("doctor_id")
  dayOfWeek    Int      @map("day_of_week") // 0-6
  startTime    DateTime @map("start_time") @db.Time
  endTime      DateTime @map("end_time") @db.Time
  slotDuration Int      @default(30) @map("slot_duration")

  doctor Doctor @relation(fields: [doctorId], references: [id])

  @@map("doctor_schedules")
}

// --- RESULTADOS MÉDICOS ---

model Diagnosis {
  id            String   @id @default(uuid())
  appointmentId String   @unique @map("appointment_id")
  doctorId      String   @map("doctor_id")
  description   String   @db.Text
  diseaseCode   String?  @map("disease_code")
  notes         String?  @db.Text
  createdAt     DateTime @default(now()) @map("created_at")

  appointment   Appointment    @relation(fields: [appointmentId], references: [id])
  doctor        Doctor         @relation(fields: [doctorId], references: [id])
  prescriptions Prescription[]

  @@map("diagnoses")
}

model Prescription {
  id             String   @id @default(uuid())
  diagnosisId    String   @map("diagnosis_id")
  medicationName String   @map("medication_name")
  dosage         String
  frequency      String
  duration       String
  instructions   String?  @db.Text
  createdAt      DateTime @default(now()) @map("created_at")

  diagnosis Diagnosis @relation(fields: [diagnosisId], references: [id])

  @@map("prescriptions")
}